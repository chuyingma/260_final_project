---
title: "mental health"
author: "Chuying Ma"
date: "11/26/2017"
output: html_document
---

BST 260 Final Project
Group: Chuying Ma, Jingjing Tang, Jie Yin, Xuewei Zhang

This Rmd file is for studying the relationship between other variables and mental health:


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Mental health patterns in 2000 for all US counties in a map:

```{r}
library(maps)
library(RColorBrewer)
library(dplyr)
library(ggplot2)
library(readr)

data_2000 = read.csv("data_2000.csv")
ment_2000 <- data_2000 %>% 
  dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_00 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_00 <- inner_join(men_map_00, ment_2000, by=c("fips" = "fips") )

map_00 = ggplot(men_df_00, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_00
```

mental health patterns in 2001 for all US counties in a map:

```{r}
data_2001 = read.csv("data_2001.csv")
ment_2001 <- data_2001 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_01 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_01 <- inner_join(men_map_01, ment_2001, by=c("fips" = "fips") )

map_01 = ggplot(men_df_01, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_01
```

mental health patterns in 2002 for all US counties in a map:

```{r}
data_2002 = read.csv("data_2002.csv")
ment_2002 <- data_2002 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_02 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_02 <- inner_join(men_map_02, ment_2002, by=c("fips" = "fips") )

map_02 = ggplot(men_df_02, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_02
```

mental health patterns in 2003 for all US counties in a map:

```{r}
data_2003 = read.csv("data_2003.csv")
ment_2003 <- data_2003 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_03 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_03 <- inner_join(men_map_03, ment_2003, by=c("fips" = "fips") )

map_03 = ggplot(men_df_03, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_03
```

mental health patterns in 2004 for all US counties in a map:

```{r}
data_2004 = read.csv("data_2004.csv")
ment_2004 <- data_2004 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_04 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_04 <- inner_join(men_map_04, ment_2004, by=c("fips" = "fips") )

map_04 = ggplot(men_df_04, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_04
```

mental health patterns in 2005 for all US counties in a map:

```{r}
data_2005 = read.csv("data_2005.csv")
ment_2005 <- data_2005 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_05 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_05 <- inner_join(men_map_05, ment_2005, by=c("fips" = "fips"))

map_05 = ggplot(men_df_05, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_05
```

mental health patterns in 2006 for all US counties in a map:

```{r}
data_2006 = read.csv("data_2006.csv")
ment_2006 <- data_2006 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_06 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_06 <- inner_join(men_map_06, ment_2006, by=c("fips" = "fips"))

map_06 = ggplot(men_df_06, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_06
```

mental health patterns in 2007 for all US counties in a map:

```{r}
data_2007 = read.csv("data_2007.csv")
ment_2007 <- data_2007 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_07 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_07 <- inner_join(men_map_07, ment_2007, by=c("fips" = "fips"))

map_07 = ggplot(men_df_07, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_07
```

mental health patterns in 2008 for all US counties in a map:

```{r}
data_2008 = read.csv("2008_data.csv")
ment_2008 <- data_2008 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_08 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_08 <- inner_join(men_map_08, ment_2008, by=c("fips" = "fips"))

map_08 = ggplot(men_df_08, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_08
```

mental health patterns in 2009 for all US counties in a map:

```{r}
data_2009 = read.csv("2009_data.csv")
ment_2009 <- data_2009 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_09 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_09 <- inner_join(men_map_09, ment_2009, by=c("fips" = "fips"))

map_09 = ggplot(men_df_09, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_09
```

mental health patterns in 2010 for all US counties in a map:

```{r}
data_2010 = read.csv("2010_data.csv")
ment_2010 <- data_2010 %>% dplyr::select(fips,menthlth)
data(county.fips)

cnty <- map_data("county")

men_map_10 <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df_10 <- inner_join(men_map_10, ment_2010, by=c("fips" = "fips"))

map_10 = ggplot(men_df_10, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt")
map_10
```


map in the same plot using facet:

```{r,eval=FALSE}
mental_data = data.frame()
mental_data = rbind(data_2000,data_2001,data_2002)
mental_data = rbind(mental_data,data_2003,data_2004)
mental_data = rbind(mental_data,data_2005,data_2006)
mental_data = rbind(mental_data,data_2007,data_2008,data_2009,data_2010)
```

```{r,eval=FALSE}

write_csv(mental_data,"10_year_data.csv")
```

```{r}
mental_data = read_csv("10_year_data.csv")
ment <- mental_data %>% dplyr::select(fips,menthlth,year)
cnty <- map_data("county")

men_map <- cnty %>%
  mutate(polyname = paste(region,subregion,sep=",")) %>%
  left_join(county.fips, by="polyname")

men_df <- inner_join(men_map, ment, by=c("fips" = "fips"))

map_all_year = ggplot(men_df, aes(long, lat,group = group)) + 
  geom_polygon(aes(fill = menthlth)) + coord_quickmap() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "RdPu"), trans = "sqrt") +
  facet_wrap(~year,ncol = 3) +
  ggtitle("Number of Days Mental Health Not Good in US counties from 2000 to 2010")

map_all_year
```

write state level data for exposure:

combine with pm2.5 and ozone:
```{r,eval=FALSE}
pm2.5 = read_csv("PM25_Ozone_county_2000_2012.csv")
pm2.5$COUNTY = as.numeric(pm2.5$COUNTY)
pm2.5_00 = pm2.5 %>%
  select(COUNTY,PM25_2000,Ozone_2000)
data_2000 = data_2000 %>%
  left_join(pm2.5_00,by = c("fips" = "COUNTY"))
colnames(data_2000)[48] = "pm2.5"
colnames(data_2000)[49] = "ozone"

write_csv(data_2000,"data_00_expo.csv")
```

```{r,eval=FALSE}
pm2.5_01 = pm2.5 %>%
  select(COUNTY,PM25_2001,Ozone_2001)
data_2001 = data_2001 %>%
  left_join(pm2.5_01,by = c("fips" = "COUNTY"))
colnames(data_2001)[48] = "pm2.5"
colnames(data_2001)[49] = "ozone"

write_csv(data_2001,"data_01_expo.csv")
```

```{r,eval=FALSE}
pm2.5_02 = pm2.5 %>%
  select(COUNTY,PM25_2002,Ozone_2002)
data_2002 = data_2002 %>%
  left_join(pm2.5_02,by = c("fips" = "COUNTY"))
colnames(data_2002)[48] = "pm2.5"
colnames(data_2002)[49] = "ozone"

write_csv(data_2002,"data_02_expo.csv")
```

```{r,eval=FALSE}
pm2.5_03 = pm2.5 %>%
  select(COUNTY,PM25_2003,Ozone_2003)
data_2003 = data_2003 %>%
  left_join(pm2.5_03,by = c("fips" = "COUNTY"))
colnames(data_2003)[48] = "pm2.5"
colnames(data_2003)[49] = "ozone"

write_csv(data_2003,"data_03_expo.csv")
```

```{r,eval=FALSE}
pm2.5_04 = pm2.5 %>%
  select(COUNTY,PM25_2004,Ozone_2004)
data_2004 = data_2004 %>%
  left_join(pm2.5_04,by = c("fips" = "COUNTY"))
colnames(data_2004)[48] = "pm2.5"
colnames(data_2004)[49] = "ozone"

write_csv(data_2004,"data_04_expo.csv")
```

```{r,eval=FALSE}
pm2.5_05 = pm2.5 %>%
  select(COUNTY,PM25_2005,Ozone_2005)
data_2005 = data_2005 %>%
  left_join(pm2.5_05,by = c("fips" = "COUNTY"))
colnames(data_2005)[48] = "pm2.5"
colnames(data_2005)[49] = "ozone"

write_csv(data_2005,"data_05_expo.csv")
```

```{r,eval=FALSE}
pm2.5_06 = pm2.5 %>%
  select(COUNTY,PM25_2006,Ozone_2006)
data_2006 = data_2006 %>%
  left_join(pm2.5_06,by = c("fips" = "COUNTY"))
colnames(data_2006)[48] = "pm2.5"
colnames(data_2006)[49] = "ozone"

write_csv(data_2006,"data_06_expo.csv")
```

```{r,eval=FALSE}
pm2.5_07 = pm2.5 %>%
  select(COUNTY,PM25_2007,Ozone_2007)
data_2007 = data_2007 %>%
  left_join(pm2.5_07,by = c("fips" = "COUNTY"))
colnames(data_2007)[48] = "pm2.5"
colnames(data_2007)[49] = "ozone"

write_csv(data_2007,"data_07_expo.csv")
```

```{r,eval=FALSE}
pm2.5_08 = pm2.5 %>%
  select(COUNTY,PM25_2008,Ozone_2008)
data_2008 = data_2008 %>%
  left_join(pm2.5_08,by = c("fips" = "COUNTY"))
colnames(data_2008)[48] = "pm2.5"
colnames(data_2008)[49] = "ozone"

write_csv(data_2008,"data_08_expo.csv")
```

```{r,eval=FALSE}
pm2.5_09 = pm2.5 %>%
  select(COUNTY,PM25_2009,Ozone_2009)
data_2009 = data_2009 %>%
  left_join(pm2.5_09,by = c("fips" = "COUNTY"))
colnames(data_2009)[48] = "pm2.5"
colnames(data_2009)[49] = "ozone"

write_csv(data_2009,"data_09_expo.csv")
```

```{r,eval=FALSE}
pm2.5_10 = pm2.5 %>%
  select(COUNTY,PM25_2010,Ozone_2010)
data_2010 = data_2010 %>%
  left_join(pm2.5_10,by = c("fips" = "COUNTY"))
colnames(data_2010)[48] = "pm2.5"
colnames(data_2010)[49] = "ozone"

write_csv(data_2010,"data_10_expo.csv")
```

combine all data to write a csv file for future use:
```{r,eval=FALSE}
all_expo = rbind(data_2000,data_2001,data_2002,data_2003,data_2004,data_2005,data_2006,data_2007,data_2008,data_2009,data_2010)

write_csv(all_expo,"data_exposure_00_10.csv")
```

run linear regression for all covariates:
```{r}
library(readr)
library(dplyr)
data_all = read_csv("data_3_expo.csv")
reg_data = data_all %>%
  dplyr::select(-c(fips,state,county,year,heartattack,ACheartdis,stroke,asthma))

full_men_model = lm(menthlth ~ .,data = reg_data)
summary(full_men_model)
```

delete income2:
```{r}
mod1 = lm(menthlth ~ age + sex + white + black + asian + educ1 + educ2 + income1 + income3 + income4 + income5 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + bmi_cat1 + bmi_cat2 + bmi_cts + genhlth_ex + genhlth_vg + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod1)
```

delete age:
```{r}
mod2 = lm(menthlth ~ sex + white + black + asian + educ1 + educ2 + income1 + income3 + income4 + income5 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + bmi_cat1 + bmi_cat2 + bmi_cts + genhlth_ex + genhlth_vg + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod2)
```

delete income3:
```{r}
mod3 = lm(menthlth ~ sex + white + black + asian + educ1 + educ2 + income1 + income4 + income5 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + bmi_cat1 + bmi_cat2 + bmi_cts + genhlth_ex + genhlth_vg + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod3)
```

delete white:
```{r}
mod4 = lm(menthlth ~ sex + black + asian + educ1 + educ2 + income1 + income4 + income5 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + bmi_cat1 + bmi_cat2 + bmi_cts + genhlth_ex + genhlth_vg + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod4)
```

delete genhlth_vg:
```{r}
mod5 = lm(menthlth ~ sex + black + asian + educ1 + educ2 + income1 + income4 + income5 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + bmi_cat1 + bmi_cat2 + bmi_cts + genhlth_ex + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod5)
```

delete income5:
```{r}
mod6 = lm(menthlth ~ sex + black + asian + educ1 + educ2 + income1 + income4 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + bmi_cat1 + bmi_cat2 + bmi_cts + genhlth_ex + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod6)
```

delete educ1:
```{r}
mod7 = lm(menthlth ~ sex + black + asian + educ2 + income1 + income4 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + bmi_cat1 + bmi_cat2 + bmi_cts + genhlth_ex + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod7)
```

delete bmi_cts:
```{r}
mod8 = lm(menthlth ~ sex + black + asian + educ2 + income1 + income4 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + bmi_cat1 + bmi_cat2 + genhlth_ex + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod8)
```

delete bmi_cat1:
```{r}
mod9 =  lm(menthlth ~ sex + black + asian + educ2 + income1 + income4 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + bmi_cat2 + genhlth_ex + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod9)
```

delete bmi_cat2:
```{r}
mod10 = lm(menthlth ~ sex + black + asian + educ2 + income1 + income4 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_ex + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod10)
```

delete black:
```{r}
mod11 = lm(menthlth ~ sex + asian + educ2 + income1 + income4 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_ex + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod11)
```

delete asian:
```{r}
mod12 = lm(menthlth ~ sex + educ2 + income1 + income4 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_ex + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod12)
```

delete sex:
```{r}
mod13 = lm(menthlth ~ educ2 + income1 + income4 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_ex + genhlth_go + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod13)
```

delete genhlth_go:
```{r}
mod14 = lm(menthlth ~ educ2 + income1 + income4 + income6 + income7 + married + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_ex + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod14)
```

delete married:
```{r}
mod15 = lm(menthlth ~ educ2 + income1 + income4 + income6 + income7 + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_ex + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod15)
```

delete income4:
```{r}
mod16 = lm(menthlth ~ educ2 + income1 + income6 + income7 + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_ex + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod16)
```

delete income6:
```{r}
mod17 = lm(menthlth ~ educ2 + income1 + income7 + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_ex + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod17)
```
delete income1:
```{r}
mod18 = lm(menthlth ~ educ2 + income7 + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_ex + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod18)
```
delete genhlth_ex:
```{r}
mod19 = lm(menthlth ~ educ2 + income7 + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod19)
```
delete educ2:
```{r}
mod20 = lm(menthlth ~  income7 + employed + out_of_work + homemaker + student + hlthplan + exercise + smoke + drink + genhlth_fa + genhlth_po + qlactlm + pm2.5 + ozone + greenness,data = reg_data)
summary(mod20)
```



this is the final regression model considering the relationship:

if we delete ozone:
```{r}
mod17 = lm(menthlth ~ black + educ2 + income1 + income4 + married + employed + out_of_work + homemaker + student + hlthplan + smoke + drink + genhlth_ex + genhlth_fa + genhlth_po + qlactlm + pm2.5,data = reg_data)
summary(mod17)
```


aggregate into state level:
```{r}
st.codes<-data.frame(
  state=c(1,2,4,5,6,8,9,10,11,12,13,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,44,45,46,47,48,49,50,51,53,54,55,56,72),full=c("alabama","alaska","arizona","arkansas","california","colorado","connecticut","delaware","district of columbia","florida","georgia","hawaii","idaho","illinois","indiana","iowa","kansas","kentucky","louisiana","maine","maryland","massachusetts","michigan","minnesota","mississippi","missouri","montana", "nebraska","nevada","new hampshire","new jersey","new mexico","new york","north carolina","north dakota","ohio","oklahoma","oregon","pennsylvania","rhode island","south carolina","south dakota","tennessee","texas","utah","vermont","virginia","washington","west virginia","wisconsin","wyoming","puerto rico"))
```


write state level data for 2000:

```{r,eval=FALSE}
library("SASxport")
library(dplyr)
data_00 <-read.xport("CDBRFS00.XPT")
data <- data_00 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(X.STATE,CTYCODE,IMONTH,MENTHLTH,CVDINFAR,CVDCORHD,CVDSTROK,ASTHMA,AGE,SEX,ORACE,EDUCA,INCOME2,MARITAL,EMPLOY,HLTHPLAN,EXERANY,X.RFSMOK2,DRINKANY,X.BMI2CAT,X.BMI2,GENHLTH,QLACTLMT)
```

NA
```{r,eval=FALSE}
data$CTYCODE[data$CTYCODE %in% c(777,999)] <- c(NA)
data$MENTHLTH[data$MENTHLTH %in% c(77,88,99)] <- c(NA) 
data$CVDINFAR[data$CVDINFAR %in% c(7,9)] <- c(NA) 
data$CVDCORHD[data$CVDCORHD %in% c(7,9)] <- c(NA) 
data$CVDSTROK[data$CVDSTROK %in% c(7,9)] <- c(NA) 
data$ASTHMA[data$ASTHMA %in% c(7,9)] <- c(NA) 
data$AGE[data$AGE %in% c(7,9)] <- c(NA) 
data$ORACE[data$ORACE %in% c(7,9)] <- c(NA)
data$EDUCA[data$EDUCA == 9] <- c(NA) 
data$INCOME2[data$INCOME2 %in% c(77,99)] <- c(NA) 
data$MARITAL[data$MARITAL == 9] <- c(NA) 
data$EMPLOY[data$EMPLOY == 9] <- c(NA) 
data$HLTHPLAN[data$HLTHPLAN %in% c(7,9)] <- c(NA) 
data$EXERANY[data$EXERANY %in% c(7,9)] <- c(NA) 
data$X.RFSMOK2[data$X.RFSMOK2 == 9] <- c(NA) 
data$DRINKANY[data$DRINKANY %in% c(7,9)] <- c(NA) 
data$X.BMI2CAT[data$X.BMI2CAT == 9] <- c(NA) 
data$X.BMI2[data$X.BMI2 == 999] <- c(NA) 
data$GENHLTH[data$GENHLTH %in% c(7,9)] <- c(NA) 
data$QLACTLM2[data$QLACTLMT %in% c(7,9)] <- c(NA) 
```


SELECT
```{r,eval=FALSE}
data00 <-data %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2000,
         menthlth = mean(MENTHLTH, na.rm= TRUE),
         heartattack = mean(CVDINFAR == 1, na.rm = TRUE),
         ACheartdis = mean(CVDCORHD == 1, na.rm = TRUE),
         stroke = mean(CVDSTROK == 1, na.rm = TRUE),
         asthma = mean(ASTHMA == 1, na.rm = TRUE),
         age = mean(AGE, na.rm = TRUE),
         sex = mean(SEX == 2, na.rm = TRUE),
         white = mean(ORACE == 1, na.rm = TRUE),
         black = mean(ORACE == 2, na.rm = TRUE),
         asian = mean(ORACE == 3, na.rm = TRUE),
         race_other = mean(ORACE == 4 | ORACE == 5 | ORACE == 6, na.rm = TRUE),
         educ1 = mean(EDUCA == 1|EDUCA == 2, na.rm = TRUE),
         educ2 = mean(EDUCA == 3|EDUCA == 4, na.rm = TRUE),
         educ3 = mean(EDUCA == 5|EDUCA == 6, na.rm = TRUE),
         income1 = mean(INCOME2 == 1, na.rm = TRUE),
         income2 = mean(INCOME2 == 2, na.rm = TRUE),
         income3 = mean(INCOME2 == 3, na.rm = TRUE),
         income4 = mean(INCOME2 == 4, na.rm = TRUE),
         income5 = mean(INCOME2 == 5, na.rm = TRUE),
         income6 = mean(INCOME2 == 6, na.rm = TRUE),
         income7 = mean(INCOME2 == 7, na.rm = TRUE),
         income8 = mean(INCOME2 == 8, na.rm = TRUE),
         married = mean(MARITAL == 1, na.rm = TRUE),
         unmarried = mean(MARITAL == 2| MARITAL == 3| MARITAL == 4| MARITAL == 5| MARITAL == 6, na.rm = TRUE),
         employed = mean(EMPLOY == 1 | EMPLOY == 2, na.rm = TRUE),
         out_of_work = mean(EMPLOY ==3 | EMPLOY ==4, na.rm = TRUE),
         homemaker = mean(EMPLOY ==5, na.rm = TRUE),
         student = mean(EMPLOY == 6, na.rm = TRUE),
         employ_other = mean(EMPLOY ==7 | EMPLOY ==8, na.rm = TRUE),
         hlthplan = mean(HLTHPLAN == 1, na.rm = TRUE),
         exercise = mean(EXERANY == 1, na.rm = TRUE),
         smoke = mean(X.RFSMOK2 == 2, na.rm = TRUE),
         drink = mean(DRINKANY == 1, na.rm = TRUE),
         bmi_cat1 = mean(X.BMI2CAT == 1, na.rm =TRUE),
         bmi_cat2 = mean(X.BMI2CAT == 2, na.rm = TRUE),
         bmi_cat3 = mean(X.BMI2CAT == 3, na.rm = TRUE),
         bmi_cts = mean(X.BMI2,na.rm = TRUE),
         genhlth_ex = mean(GENHLTH == 1, na.rm = TRUE),
         genhlth_vg = mean(GENHLTH == 2, na.rm = TRUE),
         genhlth_go = mean(GENHLTH == 3, na.rm = TRUE),
         genhlth_fa = mean(GENHLTH == 4, na.rm = TRUE),
         genhlth_po = mean(GENHLTH == 5, na.rm = TRUE),
         qlactlm = mean(QLACTLMT == 1, na.rm = TRUE))
```


```{r,eval=FALSE}
colnames(data00)[1] = "state"
data00 = data00 %>%
  left_join(st.codes,by = c("state"="state"))
```
```{r,eval=FALSE}
write.csv(data00, file = "state_00.csv")
```

Mental health patterns in 2000 for all US states in a map:

```{r}
library(fiftystater)
library(RColorBrewer)
library(mapproj)
data("fifty_states")

data00 = read_csv("state_menthlth.csv")
state_00 = data00 %>%
  dplyr::select(full,menthlth)

max(state_00$menthlth)
min(state_00$menthlth)

ggplot(state_00,aes(map_id = full)) +
  geom_map(aes(fill = menthlth),map = fifty_states) +
  expand_limits(x = fifty_states$long,y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_y_continuous(expand=c(0,0)) +
  scale_fill_gradientn(colors = rev(colorRampPalette(brewer.pal(9,"RdPu"))(5)),
                      breaks = seq(7,18,,length.out = 5),
                      limits = c(7,18),
                      labels = seq(7,18,length.out = 5)) +
  ylab("") + 
  xlab("")

```

Select average menthlth for each state across years
and write it into a csv file,
and then plot mental health across states:

```{r,eval=FALSE}
library(SASxport)
data_00 <-read.xport("CDBRFS00.XPT")
data_00 <- data_00 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(X.STATE,CTYCODE,IMONTH,MENTHLTH,CVDINFAR,CVDCORHD,CVDSTROK,ASTHMA,AGE,SEX,ORACE,EDUCA,INCOME2,MARITAL,EMPLOY,HLTHPLAN,EXERANY,X.RFSMOK2,DRINKANY,X.BMI2CAT,X.BMI2,GENHLTH,QLACTLMT)

men_00_state = data_00 %>%
  mutate(year = 2000) %>%
  select(X.STATE,MENTHLTH,year)

men_00_state$MENTHLTH[men_00_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_00_state <- men_00_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2000,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_01 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/CDBRFS01.XPT")
data_01 <- data_01 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips, X.STATE,CTYCODE,IMONTH,MENTHLTH,CVDINFR2,CVDCRHD2,CVDSTRK2,ASTHMA2,AGE,SEX,ORACE2,EDUCA,INCOME2,MARITAL,EMPLOY,HLTHPLAN,EXERANY2,X.RFSMOK2,X.BMI2CAT,X.BMI2,GENHLTH,QLACTLM2)

men_01_state = data_01 %>%
  mutate(year = 2001) %>%
  select(X.STATE,MENTHLTH,year)

men_01_state$MENTHLTH[men_01_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_01_state <- men_01_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2001,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_02 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/cdbrfs02.xpt")
data_02 <- data_02 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips, X.STATE,CTYCODE,IMONTH,MENTHLTH,CVDINFR2,CVDCRHD2,CVDSTRK2,ASTHMA2,AGE,SEX,ORACE2,EDUCA,INCOME2,MARITAL,EMPLOY,HLTHPLAN,EXERANY2,X.RFSMOK2,DRNKANY3,X.BMI2CAT,X.BMI2,GENHLTH,QLACTLM2)

men_02_state = data_02 %>%
  mutate(year = 2002) %>%
  select(X.STATE,MENTHLTH,year)

men_02_state$MENTHLTH[men_02_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_02_state <- men_02_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2002,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_03 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/cdbrfs03.xpt")
data_03 <- data_03 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips, X.STATE,CTYCODE,IMONTH,MENTHLTH,CVDINFR2,CVDCRHD2,CVDSTRK2,ASTHMA2,AGE,SEX,ORACE2,EDUCA,INCOME2,MARITAL,EMPLOY,HLTHPLAN,EXERANY2,X.RFSMOK2,DRNKANY3,X.BMI3CAT,X.BMI3,GENHLTH,QLACTLM2)

men_03_state = data_03 %>%
  mutate(year = 2003) %>%
  select(X.STATE,MENTHLTH,year)

men_03_state$MENTHLTH[men_03_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_03_state <- men_03_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2003,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_04 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/CDBRFS04.XPT")
data_04 <- data_04 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips, X.STATE,CTYCODE,MENTHLTH,CVDINFR2,CVDCRHD2,CVDSTRK2,ASTHMA2,AGE,SEX,ORACE2,EDUCA,INCOME2,MARITAL,EMPLOY,HLTHPLAN,EXERANY2,X.RFSMOK2,DRNKANY3,X.BMI4CAT,X.BMI4,GENHLTH,QLACTLM2)

men_04_state = data_04 %>%
  mutate(year = 2004) %>%
  select(X.STATE,MENTHLTH,year)

men_04_state$MENTHLTH[men_04_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_04_state <- men_04_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2004,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_05 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/CDBRFS05.XPT")
data_05 <- data_05 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips, X.STATE,CTYCODE,MSCODE,IMONTH,MENTHLTH,CVDINFR3,CVDCRHD3,CVDSTRK3,ASTHMA2,AGE,SEX,ORACE2,EDUCA,INCOME2,MARITAL,EMPLOY,HLTHPLAN,EXERANY2,X.RFSMOK3,DRNKANY4,X.BMI4CAT,X.BMI4,GENHLTH,QLACTLM2)

men_05_state = data_05 %>%
  mutate(year = 2005) %>%
  select(X.STATE,MENTHLTH,year)

men_05_state$MENTHLTH[men_05_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_05_state <- men_05_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2005,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_06 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/CDBRFS06.XPT")
data_06 <- data_06 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips, X.STATE,CTYCODE,MSCODE,IMONTH,MENTHLTH,CVDINFR3,CVDCRHD3,CVDSTRK3,ASTHMA2,AGE,SEX,ORACE2,EDUCA,INCOME2,MARITAL,EMPLOY,HLTHPLAN,EXERANY2,X.RFSMOK3,DRNKANY4,X.BMI4CAT,X.BMI4,GENHLTH,QLACTLM2)

men_06_state = data_06 %>%
  mutate(year = 2006) %>%
  select(X.STATE,MENTHLTH,year)

men_06_state$MENTHLTH[men_06_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_06_state <- men_06_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2006,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_07 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/CDBRFS07.XPT")
data_07 <- data_07 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips,X.STATE,CTYCODE,MSCODE,IMONTH,MENTHLTH,CVDINFR4,CVDCRHD4,CVDSTRK3,ASTHMA2,AGE,SEX,ORACE2,EDUCA,INCOME2,MARITAL,EMPLOY,HLTHPLAN,EXERANY2,X.RFSMOK3,DRNKANY4,X.BMI4CAT,X.BMI4,GENHLTH,QLACTLM2)

men_07_state = data_07 %>%
  mutate(year = 2007) %>%
  select(X.STATE,MENTHLTH,year)

men_07_state$MENTHLTH[men_07_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_07_state <- men_07_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2007,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_08 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/CDBRFS08.XPT")
data_08 <- data_08 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips,X.STATE, CTYCODE, MSCODE,IYEAR,MENTHLTH, CVDINFR4, CVDCRHD4,CVDSTRK3, ASTHMA2, AGE, SEX, ORACE2, EDUCA, INCOME2, MARITAL, EMPLOY, HLTHPLAN, EXERANY2, X.RFSMOK3,DRNKANY4, X.BMI4CAT, X.BMI4, GENHLTH, QLACTLM2)

men_08_state = data_08 %>%
  mutate(year = 2008) %>%
  select(X.STATE,MENTHLTH,year)

men_08_state$MENTHLTH[men_08_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_08_state <- men_08_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2008,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_09 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/CDBRFS09.XPT")
data_09 <- data_09 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips,X.STATE, CTYCODE, MSCODE,IYEAR,MENTHLTH, CVDINFR4, CVDCRHD4,CVDSTRK3, ASTHMA2, AGE, SEX, ORACE2, EDUCA, INCOME2, MARITAL, EMPLOY, HLTHPLAN, EXERANY2, X.RFSMOK3,DRNKANY4, X.BMI4CAT, X.BMI4, GENHLTH, QLACTLM2)

men_09_state = data_09 %>%
  mutate(year = 2009) %>%
  select(X.STATE,MENTHLTH,year)

men_09_state$MENTHLTH[men_09_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_09_state <- men_09_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2009,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

```{r,eval=FALSE}
data_10 <- read.xport("~/Desktop/Harvard/fall 2017/bst260/project/CDBRFS10.XPT")
data_10 <- data_10 %>% mutate(fips=X.STATE * 1000 + CTYCODE) %>%
  filter(!is.na(fips)) %>%
  select(fips,X.STATE, CTYCODE, IYEAR,MENTHLTH, CVDINFR4, CVDCRHD4,CVDSTRK3, ASTHMA2, AGE, SEX, ORACE2, EDUCA, INCOME2, MARITAL, EMPLOY, HLTHPLAN, EXERANY2, X.RFSMOK3,DRNKANY4, X.BMI4CAT, X.BMI4, GENHLTH, QLACTLM2)

men_10_state = data_10 %>%
  mutate(year = 2010) %>%
  select(X.STATE,MENTHLTH,year)

men_10_state$MENTHLTH[men_10_state$MENTHLTH %in% c(77,88,99)] <- c(NA) 

men_10_state <- men_10_state %>% group_by(X.STATE) %>%
         dplyr::summarise(year = 2010,
         menthlth = mean(MENTHLTH, na.rm= TRUE))
```

plot all years together:
```{r,eval=FALSE}
men_state = rbind(men_00_state,men_01_state,men_02_state,men_03_state,men_04_state,men_05_state,men_06_state,men_07_state,men_08_state,men_09_state,men_10_state)
```

```{r,eval=FALSE}
colnames(men_state)[1] = "state"
men_state = men_state %>%
  left_join(st.codes,by = c("state"="state"))

write_csv(men_state,"state_menthlth.csv")

```

```{r,warning=F}
library(fiftystater)
library(RColorBrewer)
library(mapproj)
data("fifty_states")
men_state = read_csv("state_menthlth.csv")

state_map = men_state %>%
  dplyr::select(full,menthlth,year)

max(state_map$menthlth,na.rm = T)
min(state_map$menthlth,na.rm = T)

ggplot(state_map,aes(map_id = full)) +
  geom_map(aes(fill = menthlth),map = fifty_states) +
  expand_limits(x = fifty_states$long,y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(expand=c(0,0)) +  
  scale_y_continuous(expand=c(0,0)) +
  scale_fill_gradientn(colors = rev(colorRampPalette(brewer.pal(9,"RdPu"))(5)),
                      breaks = seq(7,19,,length.out = 5),
                      limits = c(7,19),
                      labels = seq(7,19,length.out = 5)) +
  ylab("") + 
  xlab("") +
  facet_wrap(~year,ncol = 3) +
  ggtitle("Number of Days Mental Health Not Good for each US state from 2000 to 2010")
```


Run regression for different years and get a univariate plot each year:

```{r,warning=FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(broom)
library(dslabs)
ds_theme_set()
data_all = read_csv("data_exposure_00_10.csv")

group_men_fit = data_all %>%
  dplyr::select(-c(fips,state,county)) %>%
  ggplot(aes(pm2.5, menthlth)) +
  geom_point(alpha = 0.2,col = "dodgerblue1") +
  geom_smooth(method = "lm",col = "black") +
  facet_wrap(~ year) +
  ggtitle("mental health vs pm 2.5")
group_men_fit
```

```{r,warning=FALSE}
group_men_fit1 = data_all %>%
  dplyr::select(-c(fips,state,county)) %>%
  ggplot(aes(menthlth,ozone)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~ year) +
  ggtitle("mental health vs ozone")
group_men_fit1
```

univariate analysis for menthlth and pm 2.5:
```{r}
data_all %>%
  group_by(year) %>%
  do(tidy(lm(menthlth ~ pm2.5, data = .),conf.int = TRUE)) %>%
  filter(!grepl("Intercept", term))
```

heatmap for menthlth across US states from 2000 to 2010:

```{r,warning=FALSE}
library(RColorBrewer)

men_state = read_csv("state_menthlth.csv")
men_state %>% filter(!is.na(menthlth) & !is.na(full)) %>% 
  ggplot(aes(x = year, y = full,fill = menthlth)) + 
  geom_tile(color = "grey50") +
  scale_x_continuous(expand=c(0,0)) +  
  scale_fill_gradientn(colors = brewer.pal(9, "YlOrRd"), trans = "sqrt") +
  ylab("state") + 
  xlab("year") +
  ggtitle("Heatmap of average menthlth in US states from 2000 to 2010")
```

deal with raw ndvi data and study the relationship between greenness and menthlth:

```{r,eval=FALSE}
data_all = read_csv("data_exposure_00_10.csv")

ndvi_county = ndvi %>%
  group_by(FIPS,year) %>%
  summarise(greenness = mean(ndvimean_combined))

data_all = data_all %>%
  left_join(ndvi_county,by=c("fips"="FIPS","year"="year"))

write_csv(data_all,"data_3_expo.csv")
```

```{r,warning=FALSE}
data_all = read_csv("~/Desktop/Harvard/fall 2017/bst260/project/data_3_expo.csv")
group_men_fit2 = data_all %>%
  dplyr::select(-c(fips,state,county)) %>%
  ggplot(aes(menthlth,greenness)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~ year)
group_men_fit2
```


Draw the Pearson correlation map:

```{r}
data = read_csv("~/Desktop/Harvard/fall 2017/bst260/project/data_3_expo.csv")
data = data %>% 
  dplyr::select(income7,employed,out_of_work,homemaker,student,hlthplan,exercise,smoke, drink,genhlth_fa ,genhlth_po ,qlactlm,pm2.5 ,ozone,greenness)

data = data[complete.cases(data),]
```

```{r}
cormat <- round(cor(data),2)
head(cormat)
```

```{r}
library(reshape2)
melted_cormat <- melt(cormat)
head(melted_cormat)
```

```{r}
library(ggplot2)
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()
```

```{r}
get_lower_tri<-function(cormat){
    cormat[upper.tri(cormat)] <- NA
    return(cormat)
  }
  # Get upper triangle of the correlation matrix
  get_upper_tri <- function(cormat){
    cormat[lower.tri(cormat)]<- NA
    return(cormat)
  }
upper_tri <- get_upper_tri(cormat)
upper_tri
```

```{r}
# Melt the correlation matrix
library(reshape2)
melted_cormat <- melt(upper_tri, na.rm = TRUE)
# Heatmap
library(ggplot2)
ggplot(data = melted_cormat, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))+
 coord_fixed()
```

```{r}
reorder_cormat <- function(cormat){
# Use correlation between variables as distance
dd <- as.dist((1-cormat)/2)
hc <- hclust(dd)
cormat <-cormat[hc$order, hc$order]
}
```

```{r}
# Reorder the correlation matrix
cormat <- reorder_cormat(cormat)
upper_tri <- get_upper_tri(cormat)
# Melt the correlation matrix
melted_cormat <- melt(upper_tri, na.rm = TRUE)
# Create a ggheatmap
ggheatmap <- ggplot(melted_cormat, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))+
 coord_fixed()
# Print the heatmap
print(ggheatmap)
```

```{r,warning=FALSE}
ggheatmap + 
geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) +
theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.ticks = element_blank(),
  legend.justification = c(1, 0),
  legend.position = c(0.6, 0.7),
  legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                title.position = "top", title.hjust = 0.5))
```

try to draw the fitted line vs actual value in 2010:
firstly I want to label each state but it turns out there are too much so I give up

```{r,warning=FALSE}
library(ggrepel)
library(dplyr)
ds_theme_set()

data_all = read.csv("data_3_expo.csv")
st.codes<-data.frame(state=as.factor(c("AK", "AL", "AR", "AZ", "CA", "CO", "CT", "DC", "DE", "FL", "GA","HI", "IA", "ID", "IL", "IN", "KS", "KY", "LA", "MA", "MD", "ME","MI", "MN", "MO", "MS",  "MT", "NC", "ND", "NE", "NH", "NJ", "NM","NV", "NY", "OH", "OK", "OR", "PA", "PR", "RI", "SC", "SD", "TN", "TX", "UT", "VA", "VT", "WA", "WI", "WV", "WY")),
  full=as.factor(c("alaska","alabama","arkansas","arizona","california","colorado", "connecticut","district of columbia","delaware","florida","georgia","hawaii","iowa","idaho","illinois","indiana","kansas","kentucky","louisiana","massachusetts","maryland","maine","michigan","minnesota","missouri","mississippi","montana","north carolina","north dakota","nebraska","new hampshire","new jersey","new mexico","nevada","new york","ohio","oklahoma","oregon","pennsylvania","puerto rico","rhode island","south carolina","south dakota","tennessee","texas","utah","virginia","vermont","washington","wisconsin","west virginia","wyoming")))

highlight <- c("AK", "AL", "AR", "AZ", "CA", "CO", "CT", "DC", "DE", "FL", "GA","HI", "IA", "ID", "IL", "IN", "KS", "KY", "LA", "MA", "MD", "ME","MI", "MN", "MO", "MS",  "MT", "NC", "ND", "NE", "NH", "NJ", "NM","NV", "NY", "OH", "OK", "OR", "PA", "PR", "RI", "SC", "SD", "TN", "TX", "UT", "VA", "VT", "WA", "WI", "WV", "WY")


fips_data = county.fips %>%
  separate(polyname, c("state", "county"), ",")

data_all = data_all %>%
  left_join(fips_data,by = c("fips"="fips")) %>%
  left_join(st.codes,by = c("state.y" = "full"))

data_all_10 = data_all %>%
  dplyr::filter(year == 2010) %>%
  mutate(menthlth_hat = predict(mod20, newdata = .))

data_all_10 %>%
  ggplot(aes(menthlth_hat,menthlth,col = state,label = state)) +
  geom_point(show.legend = F) +
  geom_abline() +
  ggtitle("fitted values vs actual values of menthlth in 2010")
  


```

Univariate analysis for income vs asthma:

```{r,warning=FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(broom)
library(dslabs)
ds_theme_set()
data_all = read_csv("data_exposure_00_10.csv")

group_as_fit = data_all %>%
  dplyr::select(-c(fips,state,county)) %>%
  ggplot(aes(income1,asthma)) +
  geom_point(alpha = 0.2,col = "darkorchid2") +
  geom_smooth(method = "lm",col = "black") +
  facet_wrap(~ year) +
  ggtitle("income1 vs asthma") +
  xlim(0,0.75) +
  ylim(0,0.5)
group_as_fit
```

Univariate analysis for heartattack vs smoke:

```{r,warning=FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(broom)
library(dslabs)
ds_theme_set()
data_all = read_csv("data_exposure_00_10.csv")

group_he_fit = data_all %>%
  filter(year %in% c(2005,2006,2007,2008,2009,2010)) %>%
  dplyr::select(-c(fips,state,county)) %>%
  ggplot(aes(smoke,heartattack)) +
  geom_point(alpha = 0.2,col = "indianred1") +
  geom_smooth(method = "lm",col = "black") +
  facet_wrap(~ year) +
  ggtitle("smoke vs heartattack") +
  xlim(0,0.6) + 
  ylim(0,0.5)
group_he_fit
```



